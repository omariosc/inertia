<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/main-page-content/mainPayment.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/main-page-content/mainPayment.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {Button, Col, Container, Form, Row} from 'react-bootstrap';
import Cards from 'elt-react-credit-cards';
import React, {useEffect, useState} from 'react';
import {NotificationManager} from 'react-notifications';
import host from '../../host';
import {useNavigate, useParams} from 'react-router-dom';
import {useAccount} from '../../authorize';

/**
 * Creates the payment page for landing page
 * @return {JSX.Element}
 */
export default function MainPayment() {
  const {scooterChoiceId, hireChoiceId, startTime} = useParams();
  const [account] = useAccount();
  const navigate = useNavigate();
  const [cardNo, setCardNo] = useState('');
  const [expiry, setExpiry] = useState('');
  const [cvv, setCVV] = useState('');
  const [focus, setFocus] = useState('');
  const [validCardNo, setValidCardNo] = useState(true);
  const [validExpDate, setValidExpDate] = useState(true);
  const [validCVV, setValidCVV] = useState(true);
  const [saveCard, setSaveCard] = useState(false);
  const [savedCardDetails, setSavedCardDetails] = useState(null);

  useEffect(() => {
    checkCardExists();
  }, []);

  /**
   * Checks card number of the new booking is valid
   * @param {boolean} stateChange
   * @return {boolean}
   */
  function validateCardNo(stateChange) {
    if (savedCardDetails !== null) {
      return true;
    }
    const valid = cardNo.length > 9 &amp;&amp; cardNo.length &lt; 20;
    if (stateChange) {
      setValidCardNo(valid);
    }
    return valid;
  }

  /**
   * Checks expiry date of the card for the new booking is valid
   * @param {boolean} stateChange
   * @return {boolean}
   */
  function validateExpDate(stateChange) {
    if (savedCardDetails !== null) {
      return true;
    }
    const valid = expiry.match(/^(0[1-9]|1[0-2])\/?([0-9]{4}|[0-9]{2})$/);
    if (stateChange) {
      setValidExpDate(valid);
    }
    return valid;
  }

  /**
   * Checks CVV of the card for the new booking is valid
   * @param {boolean} stateChange
   * @return {boolean}
   */
  function validateCVV(stateChange) {
    if (savedCardDetails !== null) {
      return true;
    }
    const valid = cvv.match(/^[0-9]{3,4}$/);
    if (stateChange) {
      setValidCVV(valid);
    }
    return valid;
  }

  /**
   * If all validations pass, creates a new booking with the specified
   * information and updates backend server
   */
  async function createBooking() {
    let valid = true;
    const validateFuncs = [validateCardNo, validateCVV, validateExpDate];
    validateFuncs.forEach((validateTerm) => {
      if (valid) {
        valid = validateTerm(true);
      } else {
        validateTerm(true);
      }
    });
    if (!valid) {
      NotificationManager.error('Invalid Details Provided', 'Error');
      return;
    }
    try {
      const request = await fetch(host + 'api/Orders', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Authorization': `Bearer ${account.accessToken}`,
        },
        body: JSON.stringify({
          'hireOptionId': parseInt(hireChoiceId),
          'scooterId': parseInt(scooterChoiceId),
          'startTime': startTime,
        }),
        mode: 'cors',
      });
      const response = await request;
      if (response.status === 422) {
        NotificationManager.error('Scooter is currently unavailable.', 'Error');
      } else if (response.status === 400) {
        NotificationManager.error('Please fill in all required fields.',
            'Error');
      } else if (response.status === 200) {
        NotificationManager.success('Created Booking.', 'Success');
        if (savedCardDetails === null &amp;&amp; saveCard) {
          const card = {
            cardNumber: cardNo,
            expiryDate: expiry,
            cvv: cvv,
          };
          localStorage.setItem(account.id, JSON.stringify(card));
          NotificationManager.success('Stored credit card details.', 'Success');
        }
        navigate('/current-bookings');
      }
    } catch (error) {
      console.error(error);
    }
  }

  /**
   * Check if a card is stored in local cookies
   * @return {boolean} If card exists
   */
  function checkCardExists() {
    if (localStorage.getItem(account.id)) {
      setSavedCardDetails(JSON.parse(localStorage.getItem(account.id)));
    }
    return (!!localStorage.getItem(account.id));
  }

  return (
    &lt;div className={'content'}>
      &lt;Container>
        &lt;br/>
        &lt;div>
          {savedCardDetails === null ?
                &lt;>
                  &lt;h5>Payment details&lt;/h5>
                  &lt;Row className="pb-2 small-padding-top">
                    &lt;Col className="text-end col-9 align-self-center">
                      Save Card Details:
                    &lt;/Col>
                    &lt;Col>
                      &lt;Form.Switch onClick={(e) =>
                        setSaveCard(e.target.checked)}/>
                    &lt;/Col>
                  &lt;/Row>
                  &lt;Row className="pb-2 small-padding-top">
                    &lt;Cards
                      cvc={cvv}
                      expiry={expiry}
                      focused={focus}
                      name={(account) ? account.name : ''}
                      number={cardNo}
                    />
                  &lt;/Row>
                  &lt;Row className="pb-2 small-padding-top">
                    &lt;Col className="text-end col-3 align-self-center">
                      Card Number:
                    &lt;/Col>
                    &lt;Col className="text-end">
                      &lt;Form.Control type="text" name="number"
                        placeholder="4000-1234-5678-9010"
                        isInvalid={!validCardNo}
                        onChange={(e) => setCardNo(e.target.value)}
                        onFocus={(e) => setFocus(e.target.name)}/>
                      &lt;Form.Control.Feedback type="invalid">
                        Invalid Card Number
                      &lt;/Form.Control.Feedback>
                    &lt;/Col>
                  &lt;/Row>
                  &lt;Row className="pb-2">
                    &lt;Col className="text-end col-3 align-self-center">
                      Expiry Date:
                    &lt;/Col>
                    &lt;Col className="text-end">
                      &lt;Form.Control type="text" name="expiry"
                        placeholder="MM/YY"
                        isInvalid={!validExpDate}
                        onChange={(e) => setExpiry(e.target.value)}
                        onFocus={(e) => setFocus(e.target.name)}/>
                      &lt;Form.Control.Feedback type="invalid">
                        Invalid Expiry Date
                      &lt;/Form.Control.Feedback>
                    &lt;/Col>
                  &lt;/Row>
                  &lt;Row className="pb-2">
                    &lt;Col className="text-end col-3 align-self-center">
                      CVV:
                    &lt;/Col>
                    &lt;Col className="text-end">
                      &lt;Form.Control type="text" name="cvc" placeholder="123"
                        isInvalid={!validCVV}
                        onChange={(e) => setCVV(e.target.value)}
                        onFocus={(e) => setFocus(e.target.name)}/>
                      &lt;Form.Control.Feedback type="invalid">
                        Invalid CVV
                      &lt;/Form.Control.Feedback>
                    &lt;/Col>
                  &lt;/Row>
                &lt;/> :
                &lt;>
                  &lt;h5>Using stored payment details&lt;/h5>
                  &lt;Row className="pb-2">
                    &lt;Col className="text-end col-3 align-self-center">
                      Card Number:
                    &lt;/Col>
                    &lt;Col>
                      **** ****
                      **** {savedCardDetails.cardNumber.slice(
                          savedCardDetails.cardNumber.length - 4)}
                    &lt;/Col>
                  &lt;/Row>
                  &lt;Row className="pb-2">
                    &lt;Col className="text-end col-3 align-self-center">
                      Expiry Date:
                    &lt;/Col>
                    &lt;Col>
                      {savedCardDetails.expiryDate}
                    &lt;/Col>
                  &lt;/Row>
                  &lt;Row>
                    &lt;Col className="offset-3">
                      &lt;Button
                        variant="danger"
                        onClick={() => {
                          localStorage.removeItem(account.id);
                          NotificationManager.success(
                              'Deleted credit card details.', 'Success');
                          setSavedCardDetails(null);
                        }}>
                        Delete Card Details
                      &lt;/Button>
                    &lt;/Col>
                  &lt;/Row>
                &lt;/>
          }
        &lt;/div>
        &lt;div className="text-center large-padding-top">
          &lt;Button onClick={createBooking}>Confirm Booking&lt;/Button>
        &lt;/div>

      &lt;/Container>
    &lt;/div>
  );
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Account.html">Account</a></li></ul><h3>Global</h3><ul><li><a href="global.html#accountFromCookies">accountFromCookies</a></li><li><a href="global.html#AccountProvider">AccountProvider</a></li><li><a href="global.html#signIn">signIn</a></li><li><a href="global.html#signOut">signOut</a></li><li><a href="global.html#useAccount">useAccount</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Sun May 01 2022 22:09:55 GMT+0100 (British Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
