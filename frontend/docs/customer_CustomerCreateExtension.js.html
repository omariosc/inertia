<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: customer/CustomerCreateExtension.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: customer/CustomerCreateExtension.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* Purpose of file: Allow a customer to extend one of their ongoing bookings */

import React, {useEffect, useState} from 'react';
import {useNavigate, useParams} from 'react-router-dom';
import {Button, Col, Container, Form, Row} from 'react-bootstrap';
import {NotificationManager} from 'react-notifications';
import host from '../host';
import moment from 'moment';
import Cards from 'elt-react-credit-cards';
import {useAccount} from '../authorize';

/**
 * Renders the customer extension page, where they are able to
 * extend a currently ongoing booking
 * @return {JSX.Element} Customer create extension page
 */
export default function CustomerCreateExtension() {
  const [account] = useAccount();
  const navigate = useNavigate();
  const {orderId} = useParams();
  const [baseOrder, setBaseOrder] = useState('');
  const [hireOptions, setHireOptions] = useState('');
  const [hireChoiceId, setHireChoiceId] = useState('');
  const [price, setPrice] = useState('');
  const [cardNo, setCardNo] = useState('');
  const [expiry, setExpiry] = useState('');
  const [cvv, setCVV] = useState('');
  const [validHireSlot, setValidHireSlot] = useState(true);
  const [validCardNo, setValidCardNo] = useState(true);
  const [validExpDate, setValidExpDate] = useState(true);
  const [validCVV, setValidCVV] = useState(true);
  const [discount, setDiscount] = useState(false);
  const [discountType, setDiscountType] = useState('');
  const [loading, setLoading] = useState('');
  const [saveCard, setSaveCard] = useState(false);
  const [savedCardDetails, setSavedCardDetails] = useState(null);

  useEffect(() => {
    fetchOrderInfo();
    fetchHirePeriods();
    fetchDiscountStatus();
    checkCardExists();
  }, []);

  /**
   * Gets information of the specific order from the backend server
   */
  async function fetchOrderInfo() {
    try {
      const request = await fetch(host + `api/Orders/${orderId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Authorization': `Bearer ${account.accessToken}`,
        },
        mode: 'cors',
      });
      const response = await request;
      if (response.status === 200) {
        setBaseOrder(await response.json());
      } else {
        navigate('/current-bookings');
        NotificationManager.error('Order does not exist', 'Error');
      }
    } catch (error) {
      console.error(error);
    }
  }

  /**
   * Check if a user is eligible for frequent user status, applies the discount
   * and updates backend server if they are
   */
  async function getDiscountStatus() {
    try {
      const request = await fetch(host + `api/Users/${account.id}/orders`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Authorization': `Bearer ${account.accessToken}`,
        },
        mode: 'cors',
      });
      const response = await request.json();
      const thresholdDate = moment().subtract(1, 'week').toISOString();
      const recentBookings = response.filter(
          (e) => e.createdAt >= thresholdDate);
      let recentHours = 0;
      for (let i = 0; i &lt; recentBookings.length; i++) {
        if (recentBookings[i].orderState !== 0 &amp;&amp;
            recentBookings[i].orderState !== 6) {
          recentHours += recentBookings[i].hireOption.durationInHours;
          if (recentBookings[i]['extensions'] != null) {
            for (let j = 0; j &lt; recentBookings[i]['extensions'].length; j++) {
              // eslint-disable-next-line max-len
              recentHours += recentBookings[i]['extensions'][j].hireOption.durationInHours;
            }
          }
        }
      }
      if (recentHours >= 8) {
        setDiscount(true);
        setDiscountType('Frequent User');
      }
    } catch (e) {
      console.log(e);
    }
  }

  /**
   * Checks if the user is eligible for any other discount types
   * (e.g. Student) and applies the discount if they are
   */
  async function fetchDiscountStatus() {
    try {
      const request = await fetch(host + `api/Users/${account.id}/profile`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Authorization': `Bearer ${account.accessToken}`,
        },
        mode: 'cors',
      });
      const response = await request.json();
      if (response.userType === 0) {
        setDiscount(true);
        setDiscountType('Student');
      } else if (response.userType === 1) {
        setDiscount(true);
        setDiscountType('Senior');
      } else if (response.userType === 3) {
        setDiscount(true);
        setDiscountType('Frequent User');
      } else {
        await getDiscountStatus();
      }
      setLoading('complete');
    } catch (e) {
      console.log(e);
    }
  }

  /**
   * Gets list of available hire lengths from the backend server
   */
  async function fetchHirePeriods() {
    try {
      const request = await fetch(host + 'api/HireOptions', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Authorization': `Bearer ${account.accessToken}`,
        },
        mode: 'cors',
      });
      setHireOptions((await request.json()).sort((a, b) => a.cost - b.cost));
    } catch (error) {
      console.error(error);
    }
  }

  /**
   * Checks that the chosen hire slot is valid
   * @param {boolean} stateChange Dynamically updates UI if true
   * @return {boolean} True if valid, false otherwise
   */
  function validateHireSlot(stateChange) {
    const valid = hireChoiceId !== '' &amp;&amp; hireChoiceId !== 'none';
    if (stateChange) {
      setValidHireSlot(valid);
    }
    return valid;
  }

  /**
   * Checks that the card number for the order is valid
   * @param {boolean} stateChange Dynamically updates UI if true
   * @return {boolean} True if valid, false otherwise
   */
  function validateCardNo(stateChange) {
    if (savedCardDetails !== null) {
      return true;
    }
    const valid = cardNo.length > 9 &amp;&amp; cardNo.length &lt; 20;
    if (stateChange) {
      setValidCardNo(valid);
    }
    return valid;
  }

  /**
   * Checks that the expiry date of the card is valid
   * @param {boolean} stateChange Dynamically updates UI if true
   * @return {boolean} True if valid, false otherwise
   */
  function validateExpDate(stateChange) {
    if (savedCardDetails !== null) {
      return true;
    }
    const valid = expiry.match(/^(0[1-9]|1[0-2])\/?([0-9]{4}|[0-9]{2})$/);
    if (stateChange) {
      setValidExpDate(valid);
    }
    return valid;
  }

  /**
   * Checks that the CVV of the card is valid
   * @param {boolean} stateChange Dynamically updates UI if true
   * @return {boolean} True if valid, false otherwise
   */
  function validateCVV(stateChange) {
    if (savedCardDetails !== null) {
      return true;
    }
    const valid = cvv.match(/^[0-9]{3,4}$/);
    if (stateChange) {
      setValidCVV(valid);
    }
    return valid;
  }

  /**
   * Extends the booking for the chosen amount of time and updates the
   * backend server
   */
  async function extendBooking() {
    let valid = true;
    const validateFuncs = [
      validateHireSlot,
      validateCardNo,
      validateCVV,
      validateExpDate];
    validateFuncs.forEach((validateTerm) => {
      if (valid) {
        valid = validateTerm(true);
      } else {
        validateTerm(true);
      }
    });
    if (!valid) {
      NotificationManager.error('Invalid Details Provided', 'Error');
      return;
    }
    try {
      const request = await fetch(host + `api/Orders/${orderId}/extend`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Authorization': `Bearer ${account.accessToken}`,
        },
        body: JSON.stringify({
          'hireOptionId': parseInt(hireChoiceId),
        }),
        mode: 'cors',
      });
      const response = await request;
      if (response.status === 422) {
        NotificationManager.error('Scooter is currently unavailable.', 'Error');
      } else if (response.status === 400) {
        NotificationManager.error('Please fill in all required fields.',
            'Error');
      } else if (response.status === 200) {
        NotificationManager.success('Extended Booking.', 'Success');
        if (savedCardDetails === null &amp;&amp; saveCard) {
          const card = {
            cardNumber: cardNo,
            expiryDate: expiry,
            cvv: cvv,
          };
          localStorage.setItem(account.id, JSON.stringify(card));
          NotificationManager.success('Stored credit card details.', 'Success');
        }
        navigate('/current-bookings');
      }
    } catch (error) {
      console.error(error);
    }
  }

  /**
   * Checks if a card is stored in local cookies
   * @return {boolean} True if card exists, false otherwise
   */
  function checkCardExists() {
    if (localStorage.getItem(account.id)) {
      ``;
      setSavedCardDetails(JSON.parse(localStorage.getItem(account.id)));
    }
    return (!!localStorage.getItem(account.id));
  }

  /**
   * Displays total cost of the extension to the customer
   * @return {JSX.Element} cost element
   */
  function DisplayCost() {
    return (
        (isNaN(parseFloat(price))) ? null :
            (loading === '') ? null :
                (discount) ?
                    &lt;Row className="pb-2">
                      &lt;Col>
                        {(hireChoiceId === '') ? null :
                            &lt;>
                              &lt;h5>Cost: £{(0.9 * parseFloat(price)).toFixed(
                                  2)}&lt;/h5>
                              &lt;Row className="pb-2">
                                &lt;Col
                                  className="text-end col-3 align-self-center">
                                  Discount:
                                &lt;/Col>
                                &lt;Col>
                                  {discountType} (10%) applied
                                &lt;/Col>
                              &lt;/Row>
                            &lt;/>
                        }
                      &lt;/Col>
                    &lt;/Row> :
                    &lt;Row className="pb-2">
                      &lt;Col>
                        {(hireChoiceId === '') ?
                            &lt;h5>Cost £&lt;/h5> :
                            &lt;h5>Cost £{parseFloat(price).toFixed(2)}&lt;/h5>
                        }
                      &lt;/Col>
                    &lt;/Row>
    );
  }

  return (
    &lt;Container>
      &lt;h5>Booking Details&lt;/h5>
      &lt;Row className="pb-2">
        &lt;Col className="text-end col-3 align-self-center">
            Depot:
        &lt;/Col>
        &lt;Col>
          {(!baseOrder) ?
                &lt;> Loading depot... &lt;/> :
                &lt;Form.Control value={baseOrder.scooter.depo.name} disabled/>
          }
        &lt;/Col>
      &lt;/Row>
      &lt;Row className="pb-2">
        &lt;Col className="text-end col-3 align-self-center">
            Scooter:
        &lt;/Col>
        &lt;Col>
          {(!baseOrder) ?
                &lt;> Loading scooter... &lt;/> :
                &lt;Form.Control value={baseOrder.scooter.softScooterId} disabled/>
          }
        &lt;/Col>
      &lt;/Row>
      &lt;Row className="pb-2">
        &lt;Col className="text-end col-3 align-self-center">
            Extension Period:
        &lt;/Col>
        &lt;Col>
          {(hireOptions === '') ? &lt;>Loading extension periods...&lt;/> : &lt;>
            &lt;Form.Select isInvalid={!validHireSlot} defaultValue="none"
              onChange={(e) => {
                const value = e.target.value.split(',');
                setHireChoiceId(value[0]);
                setPrice(value[1]);
              }}>

              &lt;option value="none" key="none" disabled hidden>Select Extension
                  Period
              &lt;/option>
              {hireOptions.map((option, idx) => (
                &lt;option key={idx} value={[
                  option.hireOptionId,
                  option.cost]}>{option.name} -
                      £{option.cost}&lt;/option>
              ))}
            &lt;/Form.Select>
          &lt;/>
          }
        &lt;/Col>
      &lt;/Row>
      &lt;br/>
      &lt;DisplayCost/>
      &lt;div className="issue-filters">
        {savedCardDetails === null ?
              &lt;>
                &lt;h5>Payment details&lt;/h5>
                &lt;Row className="pb-2 small-padding-top">
                  &lt;Col className="text-end col-3 align-self-center">
                    Save Card Details:
                  &lt;/Col>
                  &lt;Col>
                    &lt;Form.Switch onClick={(e) =>
                      setSaveCard(e.target.checked)}/>
                  &lt;/Col>
                &lt;/Row>
                &lt;Row className="small-padding-bottom">
                  &lt;Cards
                    cvc={cvv}
                    expiry={expiry}
                    focused={focus}
                    name={account.name}
                    number={cardNo}
                  />
                &lt;/Row>
                &lt;Row className="pb-2 small-padding-top">
                  &lt;Col className="text-end col-3 align-self-center">
                    Card Number:
                  &lt;/Col>
                  &lt;Col className="text-end">
                    &lt;Form.Control type="text" name="number"
                      placeholder="4000-1234-5678-9010"
                      isInvalid={!validCardNo}
                      onChange={(e) => setCardNo(e.target.value)}
                      onFocus={(e) => setFocus(e.target.name)}/>
                    &lt;Form.Control.Feedback type="invalid">
                      Invalid Card Number
                    &lt;/Form.Control.Feedback>
                  &lt;/Col>
                &lt;/Row>
                &lt;Row className="pb-2">
                  &lt;Col className="text-end col-3 align-self-center">
                    Expiry Date:
                  &lt;/Col>
                  &lt;Col className="text-end">
                    &lt;Form.Control type="text" name="expiry" placeholder="MM/YY"
                      isInvalid={!validExpDate}
                      onChange={(e) => setExpiry(e.target.value)}
                      onFocus={(e) => setFocus(e.target.name)}/>
                    &lt;Form.Control.Feedback type="invalid">
                      Invalid Expiry Date
                    &lt;/Form.Control.Feedback>
                  &lt;/Col>
                &lt;/Row>
                &lt;Row className="pb-2">
                  &lt;Col className="text-end col-3 align-self-center">
                    CVV:
                  &lt;/Col>
                  &lt;Col className="text-end">
                    &lt;Form.Control type="text" name="cvc" placeholder="123"
                      isInvalid={!validCVV}
                      onChange={(e) => setCVV(e.target.value)}
                      onFocus={(e) => setFocus(e.target.name)}/>
                    &lt;Form.Control.Feedback type="invalid">
                      Invalid CVV
                    &lt;/Form.Control.Feedback>
                  &lt;/Col>
                &lt;/Row>
              &lt;/> :
              &lt;>
                &lt;h5>Using stored payment details&lt;/h5>
                &lt;Row className="pb-2">
                  &lt;Col className="text-end col-3 align-self-center">
                    Card Number:
                  &lt;/Col>
                  &lt;Col>
                    **** ****
                    **** {savedCardDetails.cardNumber.slice(
                        savedCardDetails.cardNumber.length - 4)}
                  &lt;/Col>
                &lt;/Row>
                &lt;Row className="pb-2">
                  &lt;Col className="text-end col-3 align-self-center">
                    Expiry Date:
                  &lt;/Col>
                  &lt;Col>
                    {savedCardDetails.expiryDate}
                  &lt;/Col>
                &lt;/Row>
                &lt;Row>
                  &lt;Col className="offset-3">
                    &lt;Button
                      variant="danger"
                      onClick={() => {
                        localStorage.removeItem(account.id);
                        NotificationManager.success(
                            'Deleted credit card details.', 'Success');
                        setSavedCardDetails(null);
                      }}>
                      Delete Card Details
                    &lt;/Button>
                  &lt;/Col>
                &lt;/Row>
              &lt;/>
        }
      &lt;/div>
      &lt;div className="issue-filters-mobile">
        {savedCardDetails === null ?
              &lt;>
                &lt;h5>Payment details&lt;/h5>
                &lt;Row className="small-padding-bottom">
                  Save Card Details:
                  &lt;Col>
                    &lt;Form.Switch
                      onClick={(e) => setSaveCard(e.target.checked)}/>
                  &lt;/Col>
                &lt;/Row>
                &lt;Row
                  className="small-padding-bottom customer-create-booking-card">
                  &lt;Cards
                    cvc={cvv}
                    expiry={expiry}
                    focused={focus}
                    name={account.name}
                    number={cardNo}
                  />
                &lt;/Row>
                &lt;Row className="small-padding-bottom">
                  Card Number:
                  &lt;Form.Control type="text" name="number"
                    placeholder="4000-1234-5678-9010"
                    isInvalid={!validCardNo}
                    onChange={(e) => setCardNo(e.target.value)}
                    onFocus={(e) => setFocus(e.target.name)}/>
                  &lt;Form.Control.Feedback type="invalid">
                    Invalid Card Number
                  &lt;/Form.Control.Feedback>
                &lt;/Row>
                &lt;Row className="small-padding-bottom">
                  Expiry Date:
                  &lt;Form.Control type="text" name="expiry" placeholder="MM/YY"
                    isInvalid={!validExpDate}
                    onChange={(e) => setExpiry(e.target.value)}
                    onFocus={(e) => setFocus(e.target.name)}/>
                  &lt;Form.Control.Feedback type="invalid">
                    Invalid Expiry Date
                  &lt;/Form.Control.Feedback>
                &lt;/Row>
                &lt;Row>
                  CVV:
                  &lt;Form.Control type="text" name="cvc" placeholder="123"
                    isInvalid={!validCVV}
                    onChange={(e) => setCVV(e.target.value)}
                    onFocus={(e) => setFocus(e.target.name)}/>
                  &lt;Form.Control.Feedback type="invalid">
                    Invalid CVV
                  &lt;/Form.Control.Feedback>
                &lt;/Row>
              &lt;/> :
              &lt;>
                &lt;h5>Using stored payment details&lt;/h5>
                &lt;p>Card Number: **** ****
                  **** {savedCardDetails.cardNumber.slice(
                    savedCardDetails.cardNumber.length - 4)} &lt;/p>
                &lt;p>Expiry Date: {savedCardDetails.expiryDate} &lt;/p>
                &lt;Button
                  variant="danger"
                  className="float-right"
                  onClick={() => {
                    localStorage.removeItem(account.id);
                    NotificationManager.success(
                        'Deleted credit card details.', 'Success');
                    setSavedCardDetails(null);
                  }}>
                  Delete Card Details
                &lt;/Button>
                &lt;br/>
                &lt;br/>
              &lt;/>
        }
      &lt;/div>
      &lt;br/>
      &lt;Button className="float-right"
        onClick={extendBooking}>Confirm Extension&lt;/Button>
      &lt;br/>
    &lt;/Container>
  );
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Account.html">Account</a></li></ul><h3>Global</h3><ul><li><a href="global.html#accountFromCookies">accountFromCookies</a></li><li><a href="global.html#AccountProvider">AccountProvider</a></li><li><a href="global.html#signIn">signIn</a></li><li><a href="global.html#signOut">signOut</a></li><li><a href="global.html#useAccount">useAccount</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Sun May 01 2022 22:09:55 GMT+0100 (British Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
